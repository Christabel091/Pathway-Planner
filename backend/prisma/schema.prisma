generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id               Int            @id @default(autoincrement())
  email            String         @unique(map: "email") @db.VarChar(150)
  UserName         String         @db.VarChar(150)
  password_hash    String         @db.VarChar(72)
  role             Role
  created_at       DateTime?      @default(now()) @db.DateTime(0)
  updated_at       DateTime?      @default(now()) @updatedAt @db.DateTime(0)
  profileCompleted Boolean        @default(false)
  Caretaker        Caretaker?
  Clinician        Clinician?
  notifications    Notification[]
  Patient          Patient?

  @@map("users")
}

model Patient {
  id                     Int                @id @default(autoincrement())
  user_id                Int                @unique(map: "uq_patients_user")
  clinician_id           Int                @map("clinician_id")
  full_name              String             @db.VarChar(150)
  dob                    DateTime           @db.Date
  gender                 Gender?            @default(prefer_not_say)
  phone_number           String?            @db.VarChar(20)
  address                String?            @db.VarChar(255)
  relative_contact_name  String?            @db.VarChar(150)
  relative_contact_email String?            @db.VarChar(150)
  relative_contact_phone String?            @db.VarChar(20)
   inviteCode             String?            @unique @db.VarChar(16)
  inviteUpdatedAt        DateTime?          @default(now()) @db.DateTime(0)
  blood_type             BloodType?
  allergies              String?            @db.Text
  chronic_conditions     String?            @db.Text
  current_medications    String?            @db.Text
  height_cm              Decimal?           @db.Decimal(5, 2)
  weight_kg              Decimal?           @db.Decimal(5, 2)
  created_at             DateTime?          @default(now()) @db.DateTime(0)
  updated_at             DateTime?          @default(now()) @updatedAt @db.DateTime(0)
  aiSuggestions          AiSuggestion[]
  goals                  Goal[]
  labs                   LabResult[]
  medicines              Medicine[]
  caretakerLinks         PatientCaretaker[]
  dailyLogs              PatientDailyLog[]
  clinician              Clinician          @relation(fields: [clinician_id], references: [id], onUpdate: NoAction, map: "fk_patients_clinician")
  user                   User               @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_patients_user")

  @@index([clinician_id], map: "idx_patients_clinician")
  @@map("patients")
}

model Clinician {
  id              Int       @id @default(autoincrement())
  user_id         Int       @unique(map: "uq_clinicians_user")
  full_name       String    @db.VarChar(150)
  specialty       String?   @db.VarChar(120)
  license_number  String?   @db.VarChar(100)
  clinic_name     String?   @db.VarChar(150)
  contact_email   String?   @db.VarChar(150)
  contact_phone   String?   @db.VarChar(20)
  office_address  String?   @db.VarChar(255)
  created_at      DateTime? @default(now()) @db.DateTime(0)
  updated_at      DateTime? @default(now()) @updatedAt @db.DateTime(0)
  inviteCode      String    @unique
  inviteUpdatedAt DateTime  @default(now())
  user            User      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_clinicians_user")
  patients        Patient[]

  @@map("clinicians")
}

model Caretaker {
  id           Int                @id @default(autoincrement())
  user_id      Int                @unique(map: "uq_caretakers_user")
  full_name    String             @db.VarChar(150)
  relationship String?            @db.VarChar(80)
  phone_number String?            @db.VarChar(20)
  created_at   DateTime?          @default(now()) @db.DateTime(0)
  updated_at   DateTime?          @default(now()) @updatedAt @db.DateTime(0)
  user         User               @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_caretakers_user")
  patientLinks PatientCaretaker[]

  @@map("caretakers")
}

model Notification {
  id           Int              @id @default(autoincrement())
  user_id      Int
  type         NotificationType
  entity       String?          @db.VarChar(64)
  entity_id    Int?
  payload      Json?
  created_at   DateTime?        @default(now()) @db.DateTime(0)
  delivered_at DateTime?        @db.DateTime(0)
  read_at      DateTime?        @db.DateTime(0)
  user         User             @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_notifications_user")

  @@index([user_id, created_at], map: "idx_notifications_user_created")
  @@map("notifications")
}

model PatientCaretaker {
  patient_id   Int
  caretaker_id Int
  role_note    String?   @db.VarChar(120)
  permissions  String?
  created_at   DateTime? @default(now()) @db.DateTime(0)
  caretaker    Caretaker @relation(fields: [caretaker_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_pc_caretaker")
  patient      Patient   @relation(fields: [patient_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_pc_patient")

  @@id([patient_id, caretaker_id])
  @@index([caretaker_id], map: "fk_pc_caretaker")
  @@map("patient_caretakers")
}

model Goal {
  id            Int            @id @default(autoincrement())
  patient_id    Int
  title         String         @db.VarChar(200)
  description   String?        @db.Text
  status        GoalStatus?    @default(active)
  due_date      DateTime?      @db.Date
  completed     Boolean?       @default(false)
  created_at    DateTime?      @default(now()) @db.DateTime(0)
  updated_at    DateTime?      @default(now()) @updatedAt @db.DateTime(0)
  aiSuggestions AiSuggestion[]
  patient       Patient        @relation(fields: [patient_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_goals_patient")

  @@index([patient_id], map: "idx_goals_patient")
  @@map("goals")
}

model Approval {
  id         Int            @id @default(autoincrement())
  status     ApprovalStatus @default(pending)
  note       String?        @db.VarChar(200)
  decided_at DateTime?      @default(now()) @db.DateTime(0)
  created_at DateTime?      @default(now()) @db.DateTime(0)

  @@map("approval")
}

model LabResult {
  id         Int       @id @default(autoincrement())
  patient_id Int
  lab_type   String?   @db.VarChar(100)
  lab_value  Decimal?  @db.Decimal(10, 2)
  unit       String?   @db.VarChar(100)
  source     String?   @db.VarChar(255)
  file_url   String?   @db.VarChar(255)
  decided_at DateTime? @default(now()) @db.DateTime(0)
  created_at DateTime? @default(now()) @db.DateTime(0)
  read_at    DateTime? @db.DateTime(0)
  patient    Patient   @relation(fields: [patient_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_lab_patient")

  @@index([patient_id], map: "idx_lab_patient")
  @@map("lab_result")
}

model Medicine {
  id             Int       @id @default(autoincrement())
  patient_id     Int
  medicine_name  String    @db.VarChar(200)
  dosage         String?   @db.VarChar(100)
  frequency      String?   @db.VarChar(100)
  preferred_time String?   @db.VarChar(20)
  instructions   String?   @db.VarChar(500)
  taken          Boolean   @default(false)
  taken_at       DateTime? @default(now())

  patient Patient @relation(fields: [patient_id], references: [id], onDelete: Cascade)
  @@index([patient_id])
}

model AiSuggestion {
  id                  Int       @id @default(autoincrement())
  patient_id          Int
  goal_id             Int?
  suggested_delta_pct Decimal?  @db.Decimal(6, 2)
  confidence          Decimal?  @db.Decimal(5, 2)
  requires_approval   Boolean?  @default(false)
  suggestion_text     String?   @db.Text            // <-- add this
  trigger_reason      String?   @db.VarChar(64)     // <-- optional but useful
  created_at          DateTime? @default(now()) @db.DateTime(0)
  goal                Goal?     @relation(fields: [goal_id], references: [id], onUpdate: NoAction, map: "fk_ai_goal")
  patient             Patient   @relation(fields: [patient_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_ai_patient")

  @@index([goal_id], map: "fk_ai_goal")
  @@index([patient_id], map: "fk_ai_patient")
  @@map("ai_suggestion")
}

model PatientDailyLog {
  id          Int        @id @default(autoincrement())
  patient_id  Int
  day_date    DateTime   @db.Date
  sleep_hours Decimal?   @db.Decimal(4, 2)
  notes       String?    @db.Text
  created_at  DateTime?  @default(now()) @db.DateTime(0)
  updated_at  DateTime?  @default(now()) @updatedAt @db.DateTime(0)
  exercise    String?    @db.Text
  meals       String?    @db.Text
  mood        Int?       @db.TinyInt
  symptoms    String?    @db.Text
  patient     Patient    @relation(fields: [patient_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_pdm_patient")

  @@unique([patient_id, day_date], name: "uq_pdm_patient_day", map: "uq_pdm_patient_day")
  @@index([patient_id, day_date], map: "idx_pdm_patient_day")
  @@map("patient_daily_metrics")
}

enum NotificationType {
  LAB_NEW
  GOAL_APPROVED
  MEDICATION
  MESSAGE
  ANNOUNCEMENT
}

enum Role {
  patient
  physician
  caretaker
  admin
}

enum BloodType {
  A_pos  @map("A+")
  A_neg  @map("A-")
  B_pos  @map("B+")
  B_neg  @map("B-")
  AB_pos @map("AB+")
  AB_neg @map("AB-")
  O_pos  @map("O+")
  O_neg  @map("O-")
}

enum Gender {
  male
  female
  other
  prefer_not_say
}

enum GoalStatus {
  active
  completed
  pending_approval
  cancelled
}

enum ApprovalStatus {
  pending
  approved
  rejected
}